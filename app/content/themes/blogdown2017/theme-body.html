<dom-module id="theme-body">
  <template>
    <style>
      app-toolbar {
        background-color: var(--default-primary-color);
        color: var(--paper-toolbar-color);
      }
      #content {
        padding: 20px;
      }
      #loadingBar {
        width: 100%;
        --paper-progress-height: 64px;
        --paper-progress-container-color: rgba(255, 255, 255, 0);
        --paper-progress-active-color: var(--paper-progress-secondary-color);
      }
      paper-menu {
        height: 100%;
      }
      .above-loading-bar {
        z-index: 0;
      }
      .social-account {
        color: var(--paper-toolbar-color);
        text-decoration: none;
      }
      .social-account:hover {
        color: var(--paper-toolbar-color);
        text-decoration: none;
      }
      .menu-item a {
        all: inherit;
        cursor: pointer;
      }
      .menu-item paper-item {
        font-weight: inherit;
      }
      #title {
        color: var(--paper-toolbar-color);
        text-decoration: none;
      }
      #title:hover {
        color: var(--paper-toolbar-color);
        text-decoration: none;
      }
      #social-accounts {
        margin-left: auto;
      }
      #drawer-button {
        margin-right: 10px;
      }
    </style>
    <style include="iron-positioning"></style>

    <app-drawer-layout fullbleed narrow="{{narrow}}">
      <app-drawer id="drawer" swipe-open>
        <app-toolbar></app-toolbar>
        <paper-menu selected="[[selectedMenuItem]]">
          <template is="dom-repeat" items="[[menuItems]]" as="menuItem">
            <div class="menu-item">
              <a href="/[[menuItem.slug]]">
                <paper-item on-click="_closeDrawer" id="[[menuItem.slug]]">
                  [[menuItem.title]]
                </paper-item>
              </a>
            </div>
          </template>
        </paper-menu>
      </app-drawer>

      <app-header-layout>
        <app-toolbar></app-toolbar>
        <div id="content">
          <blogdown-content></blogdown-content>
        </div>
      </app-header-layout>
    </app-drawer-layout>

    <app-toolbar class="fixed-top">
      <div class="fixed-top">
        <paper-progress id="loadingBar" class="desktop" value="[[_progress]]" indeterminate="[[loading]]"></paper-progress>
      </div>
      <paper-icon-button id="drawer-button" class="above-loading-bar" icon="menu" on-click="_toggleDrawer" hidden=[[!narrow]]></paper-icon-button>
      <a id="title" class="above-loading-bar" href="/">[[settings.title]]</a>
      <div id="social-accounts">
        <template is="dom-repeat" items=[[socialAccounts]] as="socialAccount">
          <a class="social-account" href="[[socialAccount.url]]" target="_blank">
            <paper-icon-button class="above-loading-bar" icon="fa:[[socialAccount.type]]"></paper-icon-button>
          </a>
        </template>
      </div>
    </app-toolbar>

  </template>
  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'theme-body',

        behaviors: [
          ReduxState,
          BlogdownBody
        ],

        actions: {
          updateNarrow: (narrow) => {
            return {
              type: UPDATE_NARROW,
              payload: narrow
            }
          }
        },

        properties: {
          indeterminateLoading: {
            type: Boolean,
            value: true
          },
          loading: {
            type: Boolean,
            statePath: 'meta.loading',
            observer: '_updateProgress'
          },
          progress: {
            type: Number,
            statePath: 'meta.progress',
            observer: '_updateProgress'
          },
          narrow: {
            type: Boolean,
            observer: '_updateNarrow'
          },
          settings: {
            type: Object,
            statePath: 'settings'
          },
          pages: {
            type: [],
            statePath: 'pages'
          },
          socialAccounts: {
            type: Object,
            value: []
          },
          menuItems: {
            type: Object,
            value: []
          },
          selectedMenuItem: {
            type: Number,
            statePath: 'meta.selectedMenuItem'
          }
        },

        ready: function() {
          this._loadMenuItems();
          this._loadSocialAccounts();
        },

        _loadMenuItems: function() {
          _.each(this.pages, (page) => {
            if (page.addToMenu) {
              this.push('menuItems', {
                title: page.title,
                slug: page.slug
              });
            }
          });
        },

        _loadSocialAccounts: function() {
          _.each(this.settings.socialAccounts, (socialAccount, key) => {
            this.push('socialAccounts', {
              type: key,
              url: socialAccount
            });
          });
        },

        _toggleDrawer: function() {
          this.$.drawer.toggle();
        },

        _closeDrawer: function() {
          if (this.narrow) this.$.drawer.close();
        },

        _updateNarrow: function() {
          this.dispatch('updateNarrow', this.narrow);
        },

        _updateProgress: function() {
          if (this.loading) return this.set('_progress', -1);
          return this.set('_progress', this.progress);
        }
      });
    })();
  </script>
</dom-module>
