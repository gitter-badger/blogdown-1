<dom-module id="boot-globals">
  <script>
    class BootGlobals {
      beforeRegister() {
        this.is = 'boot-globals';

        this.properties = {
          globals: {
            type: Object,
            value: {}
          }
        };

        this.log = {
          error: function(err) {
            if (store.getState().settings.logLevel.value === 1) {
              if (err.message) {
                console.log(err.message);
                return;
              }
            }
            if (store.getState().settings.logLevel.value > 1) {
              console.error(err);
              return;
            }
          },
          warn: function(err) {
            if (store.getState().settings.logLevel.value === 2) {
              if (err.message) {
                console.log(err.message);
                return;
              }
            }
            if (store.getState().settings.logLevel.value > 2) {
              console.warn(err);
              return;
            }
          },
          info: function(info) {
            if (store.getState().settings.logLevel.value >= 3) console.info(info);
          },
          debug: function(info) {
            if (store.getState().settings.logLevel.value >= 4) console.debug(info);
          },
          silly: function(info) {
            if (store.getState().settings.logLevel.value >= 5) console.log(info);
          }
        };

        this.go = {
          to: function(route) {
            page.redirect(route);
          },
          back: function() {
            window.history.back();
          }
        };
      }

      init() {
        console.log('loading globals . . .');
        return new Promise((resolve, reject) => {
          this.globals = {
            log: this.log,
            go: this.go,
            scrollToTop: this.scrollToTop,
            closeDrawer: this.closeDrawer,
            local: this.local,
            toast: this.toast,
            loadImage: this.loadImage.bind(this),
            runHook: this.runHook.bind(this)
          };
          _.each(this.globals, (global, key) => {
            app[key] = global;
          });
          app.runHook('settingsRegistered');
          app.runHook('globalsRegistered');
          resolve(this.globals);
        });
      }

      loadImage(image, page) {
        const loadImage = document.createElement('load-image');
        return loadImage.load(image, page);
      }

      scrollToTop() {
        app.log.silly('scrolling to top');
        //  app.$.headerPanelMain.scrollToTop(true);
      }

      closeDrawer() {
        app.log.silly('closing drawer');
        //   app.$.paperDrawerPanel.closeDrawer();
      }

      toast(message, link, target) {
        app.$.toast.text = message;
        if (link) {
          app.toastLink = link;
          app.toastTarget = target;
        }
        app.$.toast.show();
      }

      runHook(hookName, cx) {
        app.log.info(`â¥½: ${hookName}`);
        if (!app._hooks) app._hooks = {};
        const promises = _.map(app._hooks[hookName], (hookInstance, key) => {
          if (typeof hookInstance.then === 'function') return hookInstance(cx);
          return new Promise((resolve, reject) => {
            return resolve(hookInstance(cx));
          });
        });
        return Promise.all(promises);
      }
    }
    Polymer(BootGlobals);
  </script>
</dom-module>
