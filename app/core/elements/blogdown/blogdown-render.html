<dom-module id="blogdown-render">
  <template>
  </template>
  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'blogdown-render',

        behaviors: [ ReduxBehavior ],

        properties: {
          route: {
            type: Object,
            statePath: 'route'
          },
          baseUrl: {
            type: String,
            statePath: 'meta.baseUrl'
          },
          urlKnown: {
            type: Boolean,
            value: false
          },
          renderer: {
            type: Object,
            value: {}
          },
          url: {
            type: String,
            value: {}
          },
          body: {
            type: String,
            value: ''
          }
        },

        ready: function() {
          this.page ? this.set('content', this.page) : this.set('content', this.post);
          this.getUrl(this.content).then((url) => {
            var renderer = document.createElement(this.renderer.component);
            renderer.content = this.content;
            renderer.url = this.url;
            renderer.body = this.body;
            Polymer.dom(this.root).appendChild(renderer);
          });
        },

        getUrl: function(content) {
          var firstRenderer = null;
          var renderers = _.remove(app._renderers, (renderer) => {
            if (this.content.format !== renderer.format) return true;
            firstRenderer = renderer;
            return false;
          });
          renderers.unshift(firstRenderer);
          var promises = [];
          if (this.page) {
            _.each(renderers, (renderer) => {
              var url = `${this.baseUrl}/content/pages/${this.page.slug}.${renderer.format}`;
              promises.push(this.loadFile.bind(this, url, renderer));
            });
            if (this.page.slug !== _.snakeCase(this.page.title).replace(/_/g, '-')) {
              _.each(renderers, (renderer) => {
                var url = `${this.baseUrl}/content/pages/${_.snakeCase(this.page.title).replace(/_/g, '-')}.${renderer.format}`;
                promises.push(this.loadFile.bind(this, url, renderer));
              });
            }
          } else {
            _.each(renderers, (renderer) => {
              var url = `${this.baseUrl}/content/${this.route.slugs.parent}/${this.post.slug}.${renderer.format}`;
              promises.push(this.loadFile.bind(this, url, renderer));
            });
            if (this.post.slug !== _.snakeCase(this.post.title).replace(/_/g, '-')) {
              _.each(renderers, (renderer) => {
                var url = `${this.baseUrl}/content/${this.route.slugs.parent}/${_.snakeCase(this.post.title).replace(/_/g, '-')}.${renderer.format}`;
                promises.push(this.loadFile.bind(this, url, renderer));
              });
            }
            if (this.post.date && this.post.slug !== this.post.date.format('X')) {
              _.each(renderers, (renderer) => {
                var url = `${this.baseUrl}/content/${this.route.slugs.parent}/${this.post.date.format('X')}.${renderer.format}`;
                promises.push(this.loadFile.bind(this, url, renderer));
              });
            }
          }
          var promiseChain = Promise.resolve();
          _.each(promises, (promise) => {
            promiseChain = promiseChain.then(promise);
          });
          return promiseChain.then(() => {
            return this.url;
          });
        },

        loadFile: function(url, renderer) {
          url = url + '?' + moment().format('X');
          if (this.urlKnown) return Promise.resolve();
          return fetch(url).then((res) => {
            if (res.status === 404) return null;
            return res.text();
          }).then((body) => {
            if (body) {
              this.set('body', body);
              this.set('url', url);
              this.set('renderer', renderer);
              this.set('urlKnown', true);
            }
          });
        }
      });
    })();
  </script>
</dom-module>
