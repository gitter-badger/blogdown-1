<dom-module id="boot-globals">
  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'boot-globals',

        properties: {
          globals: {
            type: Object,
            value: {}
          }
        },

        init: function() {
          console.log('loading globals . . .');
          return new Promise((resolve, reject) => {
            this.globals = {
              log: this.log,
              go: this.go,
              scrollToTop: this.scrollToTop,
              closeDrawer: this.closeDrawer,
              local: this.local,
              toast: this.toast,
              loadImage: this.loadImage.bind(this),
              runHook: this.runHook.bind(this)
            };
            _.each(this.globals, (global, key) => {
              app[key] = global;
            });
            resolve(this.globals);
          });
        },

        loadImage: function(image, page) {
          let loadImage = document.createElement('load-image');
          return loadImage.load(image, page);
        },

        log: {
          error: function(err) {
            if (store.getState().settings.logLevel.value === 1) {
              if (err.message) return console.log(err.message);
            }
            if (store.getState().settings.logLevel.value > 1) return console.error(err);
          },
          warn: function(err) {
            if (store.getState().settings.logLevel.value === 2) {
              if (err.message) return console.log(err.message);
            }
            if (store.getState().settings.logLevel.value > 2) return console.warn(err);
          },
          info: function(info) {
            if (store.getState().settings.logLevel.value >= 3) return console.info(info);
          },
          debug: function(info) {
            if (store.getState().settings.logLevel.value >= 4) return console.debug(info);
          },
          silly: function(info) {
            if (store.getState().settings.logLevel.value >= 5) return console.log(info);
          }
        },

        go: {
          to: function(route) {
            page.redirect(route);
          },
          back: function() {
            window.history.back();
          }
        },

        scrollToTop: function() {
          app.log.silly('scrolling to top');
          //  app.$.headerPanelMain.scrollToTop(true);
        },

        closeDrawer: function() {
          app.log.silly('closing drawer');
          //   app.$.paperDrawerPanel.closeDrawer();
        },

        toast: function(message, link, target) {
          app.$.toast.text = message;
          if (link) {
            app.toastLink = link;
            app.toastTarget = target;
          }
          app.$.toast.show();
        },

        runHook: function(hookName, cx) {
          app.log.info(`â¥½: ${hookName}`);
          if (!app._hooks) app._hooks = {};
          var promises = _.map(app._hooks[hookName], (hookInstance, key) => {
            if (typeof hookInstance.then === 'function') {
              return hookInstance(cx);
            } else {
              return new Promise((resolve, reject) => {
                return resolve(hookInstance(cx));
              });
            }
          });
          return Promise.all(promises);
        }
      });
    })();
  </script>
</dom-module>
