<dom-module id="boot-hooks">
  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'boot-hooks',

        behaviors: [ ReduxBehavior ],

        properties: {
          settings: {
            type: Object,
            statePath: 'settings'
          },
          internalHookComponents: {
            type: Array,
            value: [
              'core'
            ]
          }
        },

        init: function() {
          app.log.info('registering hooks . . .');
          var promises = _.flatten([_.map(this.settings.modules, (module) => {
            return this.getModuleHooks(module).then((hooks) => {
              return this.registerHooks(hooks);
            });
          }), _.map(this.internalHookComponents, (internal) => {
            return this.getInternalHooks(internal).then((hooks) => {
              return this.registerHooks(hooks);
            });
          })]);
          return Promise.all(promises).then(() => {
            app.runHook('settingsRegistered');
            app.runHook('globalsRegistered');
            app.runHook('hooksRegistered');
            return Promise.resolve(app._hooks);
          });
        },

        getModuleHooks: function(moduleName) {
          var blogdownModule = document.createElement('blogdown-module');
          blogdownModule.name = moduleName;
          return blogdownModule.createModule().then((module) => {
            if (module.registerHooks) return module.registerHooks();
            return {};
          });
        },

        getInternalHooks: function(internalName) {
          var internal = document.createElement(`hooks-${internalName}`);
          if (internal.registerHooks) return Promise.resolve(internal.registerHooks());
          return Promise.resolve({});
        },

        registerHooks: function(hooks) {
          if (!app._hooks) app._hooks = {};
          _.each(hooks, (hook, key) => {
            app._hooks[key] ? app._hooks[key].push(hook) : app._hooks[key] = [hook];
          });
        }
      });
    })();
  </script>
</dom-module>
