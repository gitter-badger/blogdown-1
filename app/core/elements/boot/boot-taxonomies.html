<dom-module id="boot-taxonomies">
  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'boot-taxonomies',

        behaviors: [ ReduxBehavior ],

        actions: {
          loadTaxonomies: function() {
            return (dispatch) => {
              var promises = _.map(this.settings.taxonomies, (taxonomy) => {
                return this.loadTaxonomy(taxonomy);
              });
              return Promise.all(promises).then((taxonomiesMeta) => {
                var taxonomies = {};
                _.each(taxonomiesMeta, (taxonomy) => {
                  taxonomies[taxonomy.name] = taxonomy.posts;
                });
                dispatch({
                  type: LOAD_TAXONOMIES,
                  taxonomies: taxonomies
                });
                app.runHook('taxonomiesRegistered', taxonomies);
                this.resolve(taxonomies);
                return taxonomies;
              }).catch((err) => {
                this.reject(err);
                throw err;
              });
            };
          }
        },

        properties: {
          baseUrl: {
            type: String,
            statePath: 'meta.baseUrl'
          },
          settings: {
            type: Object,
            statePath: 'settings'
          }
        },

        init: function() {
          app.log.debug('loading taxonomies . . .');
          return new Promise((resolve, reject) => {
            this.resolve = resolve;
            this.reject = reject;
            this.dispatch('loadTaxonomies');
          });
        },

        loadTaxonomy: function(taxonomy) {
          return fetch('../../../content/' + taxonomy.name + '.json?' + moment().format('X'))
            .then((res) => {
              return res.json();
            }).then((body) => {
              return this.getTaxonomyMeta(taxonomy, body);
            });
        },

        getTaxonomyMeta: function(taxonomy, posts) {
          var taxonomyPosts = [];
          _.each(posts, (post) => {
            var date = false;
            if (post.date) {
              if (typeof post.date === 'number') {
                date = moment.unix(post.date);
              } else {
                date = moment(new Date(post.date));
              }
            }
            var title = false;
            if (post.title) {
              title = post.title;
            } else if (post.author) {
              title = _.startCase(taxonomy.singularForm.replace('-', ' '));
            } else if (date) {
              title = _.startCase(taxonomy.singularForm.replace('-', ' ')) + ' on ' + date.format(this.settings.dateFormat);
            }
            var slug = post.slug;
            if (!slug) {
              if (date && this.settings.permlinkMode === 'date') {
                slug = date.format('X');
              } else {
                slug = _.snakeCase(title).replace('_', '-');
              }
            }
            var featuredImage = post.featuredImage ? post.featuredImage : false;
            if (typeof featuredImage === 'string') {
              var matches = featuredImage.match(/^(((https*)|file):)*\/{2}/g);
              if (!matches) {
                featuredImage = this.baseUrl + '/content/assets' + ((featuredImage[0] === '/') ? featuredImage : ('/' + featuredImage));
              }
            }
            var postMeta = {
              title: title,
              slug: slug,
              date: date,
              author: post.author ? post.author : false,
              featuredImage: featuredImage,
              description: post.description ? post.description : '',
              format: post.format ? post.format : 'md',
              taxonomy: taxonomy
            };
            _.each(post, (value, key) => {
              if (!_.includes(_.keys(postMeta), key)) {
                postMeta[key] = value;
              }
            });
            taxonomyPosts.push(postMeta);
          });
          return {
            name: taxonomy.name,
            posts: taxonomyPosts
          }
        }
      });
    })();
  </script>
</dom-module>
