<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="page-content">
  <template>

    <template is="dom-if" if="[[booleanFormat.md]]" restamp>
      <marked-element markdown="[[body]]">
        <div class="markdown-html"></div>
      </marked-element>
    </template>

    <template is="dom-if" if="[[booleanFormat.html]]" restamp>
      <template is="juicy-html" content$="[[body]]"></template>
    </template>

    <template is="dom-if" if="[[booleanFormat.pdf]]" restamp>
      <pdf-object file="[[url]]" height="400px"></pdf-object>
      <paper-button on-click="_download">Fullscreen</paper-button>
    </template>

    <template is="dom-if" if="[[booleanFormat.dyn-html]]" restamp>
      <page-dyn page="[[page]]" format="dyn.html"></page-dyn>
    </template>
    <template is="dom-if" if="[[booleanFormat.dyn]]" restamp>
      <page-dyn page="[[page]]" format="dyn"></page-dyn>
    </template>

  </template>
  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'page-content',

        behaviors: [
          ReduxBehavior,
          ReduxActions
        ],

        properties: {
          baseUrl: {
            type: String,
            statePath: 'meta.baseUrl'
          },
          page: {
            type: Object,
            value: {},
            observer: 'pageChanged'
          },
          fileKnown: {
            type: Boolean,
            value: false
          },
          booleanFormat: {
            type: Object,
            value: {}
          },
          body: {
            type: String,
            value: ''
          },
          fileName: {
            type: String,
            value: ''
          },
          format: {
            type: String,
            value: ''
          }
        },

        pageChanged: function() {
          this.set('fileKnown', false);
          this.set('booleanFormat', {});
          this.set('format', {});
          this.set('body', '');
          this.set('fileName', '');
          window.setTimeout(() => {
            if (this.page.slug && !this.page.taxonomy) return this._loadPage(this.page);
          }, 1);
        },

        _loadPage: function(page) {
          var formats = [page.format];
          _.each([
            'md',
            'html',
            'pdf',
            'dyn.html',
            'dyn'
          ], (format) => {
            if (format !== page.format) formats.push(format);
          });
          if (formats[0] === 'dyn.html') {
            formats = _.remove(formats, (format) => {
              return format !== 'dyn';
            });
            formats.splice(1, 0, 'dyn');
          }
          var promises = [];
          _.each(formats, (format) => {
            var url = this.baseUrl + '/content/pages/' + page.slug + '.' + format;
            promises.push(this._getFile.bind(this, url, format, page.slug));
          });
          if (page.slug !== changeCase.paramCase(page.title)) {
            _.each(formats, (format) => {
              var url = this.baseUrl + '/content/pages/' + changeCase.paramCase(page.title) + '.' + format;
              promises.push(this._getFile.bind(this, url, format, changeCase.paramCase(page.title)));
            });
          }
          var promiseChain = Promise.resolve();
          _.each(promises, (promise) => {
            promiseChain = promiseChain.then(promise);
          });
          promiseChain.then(() => {
            this._setBooleanFormat(this.format);
            if (this.format) {
              if (this.format !== 'dyn' && this.format !== 'dyn.html') {
                app.log.info('pages/' + this.fileName + '.' + this.format + ' was imported.');
                this.dispatch('appLoading', false);
              }
            } else {
              app.log.warn('404 error');
              app.go.to('/404');
            }
          }).catch((err) => {
            app.log.error(err);
          });
        },

        _getFile: function(url, format, fileName) {
          if (this.fileKnown) return Promise.resolve();
          return fetch(url).then((res) => {
            if (res.status === 404) return '';
            if (res.status >= 200 && res.status < 400) {
              this.set('fileKnown', true);
              this.set('format', format);
              this.set('url', url);
              this.set('fileName', fileName);
              return res.text();
            }
            var err = new Error('Error gettings file');
            err.res = res;
            throw err;
          }).then((body) => {
            this.set('body', body);
            return;
          });
        },

        _setBooleanFormat: function(format) {
          if (format) {
            var tmp = {};
            tmp[format.replace('.', '-')] = true;
            this.set('booleanFormat', tmp);
          }
        },

        _download: function() {
          window.open(this.url);
        }
      });
    })();
  </script>
</dom-module>
