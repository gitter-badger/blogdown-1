<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="post-content">
  <template>
    <style>
      .markdown-html img {
        max-width: 100%;
      }
    </style>

    <template is="dom-if" if="[[booleanFormat.md]]" restamp>
      <marked-element markdown="[[body]]">
        <div class="markdown-html"></div>
      </marked-element>
    </template>

    <template is="dom-if" if="[[booleanFormat.html]]" restamp>
      <template is="juicy-html" content$="[[body]]"></template>
    </template>

    <template is="dom-if" if="[[booleanFormat.pdf]]" restamp>
      <div class="card-content">
        <pdf-object file="[[url]]" height="400px"></pdf-object>
      </div>
      <div class="card-actions">
        <paper-button on-click="_download">Fullscreen</paper-button>
      </div>
    </template>

    <template is="dom-if" if="[[booleanFormat.dyn-html]]" restamp>
      <post-dyn post="[[post]]" format="dyn.html" parent="[[route.slugs.parent]]"></page-dyn>
    </template>
    <template is="dom-if" if="[[booleanFormat.dyn]]" restamp>
      <post-dyn post="[[post]]" format="dyn" parent="[[route.slugs.parent]]"></page-dyn>
    </template>

  </template>
  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'post-content',

        behaviors: [
          ReduxBehavior,
          ReduxActions
        ],

        properties: {
          baseUrl: {
            type: String,
            statePath: 'meta.baseUrl'
          },
          post: {
            type: Object,
            value: {},
            observer: 'postChanged'
          },
          fileKnown: {
            type: Boolean,
            value: false
          },
          booleanFormat: {
            type: Object,
            value: {}
          },
          body: {
            type: String,
            value: ''
          },
          route: {
            type: Object,
            statePath: 'route'
          },
          fileName: {
            type: String,
            value: ''
          },
          format: {
            type: String,
            value: ''
          }
        },

        postChanged: function() {
          this.set('fileKnown', false);
          this.set('booleanFormat', {});
          this.set('body', '');
          this.set('fileName', '');
          this.set('format', '');
          window.setTimeout(() => {
            if (this.post.slug) return this._loadPost(this.post, this.route);
          }, 1);
        },

        _loadPost: function(post, route) {
          var formats = [post.format];
          _.each([
            'md',
            'html',
            'pdf',
            'dyn.html',
            'dyn'
          ], (format) => {
            if (format !== post.format) formats.push(format);
          });
          if (formats[0] === 'dyn.html') {
            formats = _.remove(formats, (format) => {
              return format !== 'dyn';
            });
            formats.splice(1, 0, 'dyn');
          }
          var promises = [];
          _.each(formats, (format) => {
            var url = this.baseUrl + '/content/' + route.slugs.parent + '/' + post.slug + '.' + format;
            promises.push(this._getFile.bind(this, url, format, post.slug));
          });
          if (post.slug !== changeCase.paramCase(post.title)) {
            _.each(formats, (format) => {
              var url = this.baseUrl + '/content/' + route.slugs.parent + '/' + changeCase.paramCase(post.title) + '.' + format;
              promises.push(this._getFile.bind(this, url, format, changeCase.paramCase(post.title)));
            });
          }
          if (post.date && post.slug !== post.date.format('X')) {
            _.each(formats, (format) => {
              var url = this.baseUrl + '/content/' + route.slugs.parent + '/' + post.date.format('X') + '.' + format;
              promises.push(this._getFile.bind(this, url, format, post.date.format('X')));
            });
          }
          var promiseChain = Promise.resolve();
          _.each(promises, (promise) => {
            promiseChain = promiseChain.then(promise);
          });
          promiseChain.then(() => {
            this._setBooleanFormat(this.format);
            if (this.format) {
              if (this.format !== 'dyn' && this.format !== 'dyn.html') {
                app.log.info(route.slugs.parent + '/' + this.fileName + '.' + this.format + ' was imported.');
                this.dispatch('appLoading', false);
              }
            } else {
              app.log.error('404 error');
              app.go.to('/404');
            }
          }).catch((err) => {
            app.log.error(err);
          });
        },

        _getFile: function(url, format, fileName) {
          url = url + '?' + moment().format('X');
          if (this.fileKnown) return Promise.resolve();
          return fetch(url).then((res) => {
            if (res.status === 404) return '';
            if (res.status >= 200 && res.status < 400) {
              this.set('fileKnown', true);
              this.set('format', format);
              this.set('url', url);
              this.set('fileName', fileName);
              return res.text();
            }
            var err = new Error('Error gettings file');
            err.res = res;
            throw err;
          }).then((body) => {
            this.set('body', this._filterBody(body));
            return;
          });
        },

        _filterBody: function(body) {
          body = body.replace(/\(\/assets\//g, '(/content/assets/');
          return body;
        },

        _setBooleanFormat: function(format) {
          if (format) {
            var tmp = {};
            tmp[format.replace('.', '-')] = true;
            this.set('booleanFormat', tmp);
          }
        }
      });
    })();
  </script>
</dom-module>
