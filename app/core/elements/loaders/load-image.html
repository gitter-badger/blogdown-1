<dom-module id="load-image">
  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'load-image',

        behaviors: [ ReduxBehavior ],

        properties: {
          baseUrl: {
            type: String,
            statePath: 'meta.baseUrl'
          },
          _image: {
            type: String
          },
          route: {
            type: Object,
            statePath: 'route'
          },
          _format: {
            type: String,
            value: 'png'
          },
          _fileKnown: {
            type: Boolean,
            value: false
          }
        },

        load: function(page, image) {
          if (!image) image = page.featuredImage;
          return new Promise((resolve, reject) => {
            if (!image) return resolve(false);
            if (typeof image === 'string') {
              var img = document.createElement('img');
              img.onload = () => {
                this.set('_image', image);
                app.log.info(this._image + ' was imported.');
                resolve(this._image);
              };
              img.onerror = (err) => {
                var matches = image.match(/(?!\.)[\w]+$/g);
                var format = matches[0];
                this._setFormat(page, format, image).then(() => {
                  if (this._image) {
                    var image = this._image;
                    if (image.indexOf(this.baseUrl + '/content') === 0) {
                      image = image.substring(this.baseUrl.length + 9, image.length);
                    }
                    app.log.info(image + ' was imported.');
                    resolve(this._image);
                  } else {
                    app.log.warn(image + ' failed to import');
                    resolve(false);
                  }
                });
              };
              img.src = image;
            } else {
              this._setFormat(page, this._format, image).then(() => {
                if (this._image) {
                  var image = this._image;
                  if (image.indexOf(this.baseUrl + '/content') === 0) {
                    image = image.substring(this.baseUrl.length + 9, image.length);
                  }
                  app.log.info(image + ' was imported.');
                  resolve(this._image);
                } else {
                  app.log.warn(image + ' failed to import');
                  resolve(false);
                }
              });
            }
          }).catch((err) => {
            app.log.error(err);
          });
        },

        _setFormat: function(page, format, image) {
          var formats = [format];
          _.each([
            'jpg',
            'png',
            'jpeg',
            'gif'
          ], (_format) => {
            if (_format !== format) formats.push(_format);
          });
          var promises = [];
          var basePath = this.baseUrl + '/content/pages';
          if (this.route.slugs.child) {
            basePath = this.baseUrl + '/content/' + this.route.slugs.parent;
          }
          _.each(formats, (format) => {
            var image1 = basePath + '/' + page.slug + '.' + format;
            var image2 = this.baseUrl + '/images/' + page.slug + '.' + format;
            if (image1 !== image) promises.push(this._getFile.bind(this, image1, format, page.slug));
            if (image2 !== image) promises.push(this._getFile.bind(this, image2, format, page.slug));
          });
          if (page.slug !== changeCase.paramCase(page.title)) {
            _.each(formats, (format) => {
              var image1 = basePath + '/' + page.slug + '.' + format;
              var image2 = this.baseUrl + '/images/' + page.slug + '.' + format;
              if (image1 !== image) promises.push(this._getFile.bind(this, image1, format, changeCase.paramCase(page.title)));
              if (image2 !== image) promises.push(this._getFile.bind(this, image2, format, changeCase.paramCase(page.title)));
            });
          }
          if (page.date && page.slug !== page.date.format('X')) {
            _.each(formats, (format) => {
              var image1 = basePath + '/' + page.slug + '.' + format;
              var image2 = this.baseUrl + '/images/' + page.slug + '.' + format;
              if (image1 !== image) promises.push(this._getFile.bind(this, image1, format, page.date.format('X')));
              if (image2 !== image) promises.push(this._getFile.bind(this, image2, format, page.date.format('X')));
            });
          }
          var promiseChain = Promise.resolve();
          _.each(promises, (promise) => {
            promiseChain = promiseChain.then(promise);
          });
          return promiseChain;
        },

        _getFile: function(image, format) {
          if (this._fileKnown) return Promise.resolve();
          return fetch(image).then((res) => {
            if (res.status === 404) return;
            if (res.status >= 200 && res.status < 400) {
              this.set('_fileKnown', true);
              this.set('_format', format);
              this.set('_image', image);
              return;
            }
            var err = new Error('Error getting image');
            err.res = res;
            throw err;
          });
        }
      });
    })();
  </script>
</dom-module>
