<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="load-taxonomies">
  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'load-taxonomies',

        behaviors: [ ReduxBehavior ],

        actions: {
          loadTaxonomies: function() {
            return (dispatch) => {
              var promises = _.map(this.settings.taxonomies, (taxonomy) => {
                return this._loadTaxonomy(taxonomy);
              });
              return Promise.all(promises).then((taxonomiesMeta) => {
                var taxonomies = {};
                _.each(taxonomiesMeta, (taxonomy) => {
                  taxonomies[taxonomy.name] = taxonomy.posts;
                });
                dispatch({
                  type: LOAD_TAXONOMIES,
                  taxonomies: taxonomies
                });
                app.log.info('taxonomies =>');
                app.log.info(store.getState().taxonomies);
                this.resolve(taxonomies);
                return taxonomies;
              }).catch((err) => {
                this.reject(err);
                throw err;
              });
            };
          }
        },

        properties: {
          settings: {
            type: Object,
            statePath: 'settings'
          }
        },

        load: function() {
          app.log.debug('loading taxonomies . . .');
          return new Promise((resolve, reject) => {
            this.resolve = resolve;
            this.reject = reject;
            this.dispatch('loadTaxonomies');
          });
        },

        _loadTaxonomy: function(taxonomy) {
          return fetch('../../../content/' + taxonomy.name + '.json')
            .then((res) => {
              return res.json();
            }).then((body) => {
              return this._getTaxonomyMeta(taxonomy, body);
            });
        },

        _getTaxonomyMeta: function(taxonomy, posts) {
          var taxonomyPosts = [];
          _.each(posts, (post) => {
            var date = false;
            if (post.date) {
              if (typeof post.date === 'number') {
                date = moment.unix(post.date);
              } else {
                date = moment(new Date(post.date));
              }
            }
            var title = false;
            if (post.title) {
              title = post.title;
            } else if (post.author) {
              title = changeCase.titleCase(taxonomy.singularForm) + ' by ' + post.author;
            } else if (date) {
              title = changeCase.titleCase(taxonomy.singularForm) + ' on ' + date.format(this.settings.dateFormat);
            }
            var slug = post.slug;
            if (!slug) {
              if (date && this.settings.permlinkMode === 'date') {
                slug = date.format('X');
              } else {
                slug = changeCase.paramCase(title);
              }
            }
            var postMeta = {
              title: title,
              slug: slug,
              date: date,
              author: post.author ? post.author : false,
              featuredImage: post.featuredImage ? post.featuredImage : false,
              description: post.description ? post.description : '',
              format: post.format ? post.format : 'md',
              taxonomy: taxonomy
            };
            _.each(post, (value, key) => {
              if (!_.includes(_.keys(postMeta), key)) {
                postMeta[key] = value;
              }
            });
            taxonomyPosts.push(postMeta);
          });
          return {
            name: taxonomy.name,
            posts: taxonomyPosts
          }
        }
      });
    })();
  </script>
</dom-module>
