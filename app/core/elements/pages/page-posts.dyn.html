<dom-module id="page-posts">
  <template>
    <style>
      paper-card.post {
        @apply(--layout-horizontal);
      }
      .post-background {
        position: relative;
        width: 33.4%;
      }
      .post-background-color {
        position: absolute;
        width: 100%;
        height: 100%;
        background-color: black;
        opacity: .2;
      }
      .post-image {
        position: absolute;
        width: 100%;
        height: 100%;
        background-size: cover;
      }
      .post-content {
        @apply(--layout-flex);
        float: left;
      }
      .post-header {
        @apply(--paper-font-headline);
      }
      .post-name {
        color: var(--paper-grey-600);
        padding: 16px 0;
      }
    </style>

    <template is="dom-repeat" items="[[posts]]" as="post">
      <template is="dom-if" if="[[post.featuredImage]]" restamp>
        <paper-card class="post">
          <div class="post-content">
            <div class="card-content">
              <div class="post-header">[[post.title]]</div>
              <div class="post-name">[[post.description]]</div>
            </div>
            <div class="card-actions">
              <paper-button on-click="_goToPost">Read More</paper-button>
              <paper-button on-click="_goToProject" hidden="[[!post.viewProject]]">View Project</paper-button>
            </div>
          </div>
          <div class="post-background">      
            <div class="post-image" style="background-image:url('[[post.featuredImage]]')"></div>
            <div class="post-background-color"></div>
          </div>
        </paper-card>
      </template>
      <template is="dom-if" if="[[!post.featuredImage]]" restamp>
        <paper-card class="post">
          <div class="post-content">
            <div class="card-content">
              <div class="post-header">[[post.title]]</div>
              <div class="post-name">[[post.description]]</div>
            </div>
            <div class="card-actions">
              <paper-button on-click="_goToPost">Read More</paper-button>
              <paper-button on-click="_goToProject" hidden="[[!post.viewProject]]">View Project</paper-button>
            </div>
          </div>
        </paper-card>
      </template>
    </template>
    
  </template>

  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'page-posts',

        ready: function() {
          this.set('posts', app.posts);
          for (var i = 0; i < this.posts.length; i++) {
            this._determineFeaturedImage(this.posts[i].featuredImage, i);
          }
        },
        
        _goToPost: function(e) {
          var post = e.model.post;
          app.goTo('/post/' + post.slug);
        },
        
        _goToProject: function(e) {
          console.log(e.model);
          var post = e.model.post;
          console.log(post);
          window.open(post.viewProject, '_blank');
        },
        
        _determineFeaturedImage: function(featuredImage, i) {
          if (featuredImage) {
            if (featuredImage === true) { // Featured image assumed
              if (app.settings.permlinkMode === 'date') { // date mode
                featuredImage = app.rootURL + 'content/images/' + this.posts[i].slug + '.jpg';
                this._checkImage(featuredImage, function() { // Image exists
                  this.set('posts.' + i + '.featuredImage', featuredImage);
                }.bind(featuredImage, i), function() { // Image doesn't exist
                  featuredImage = app.rootURL + 'content/images/' + this.posts[i].slug + '.png';
                  this._checkImage(featuredImage, function() { // Image exists
                    this.set('posts.' + i + '.featuredImage', featuredImage);
                  }.bind(featuredImage, i), function() { // Image doesn't exist
                    var title = this.post.title.toString().toLowerCase().replace(/[^\s\w+\-_#.]/g, '').replace(/\s+/g, '-');
                    featuredImage = app.rootURL + 'content/images/' + this._title + '.jpg';
                    this._checkImage(featuredImage, function() { // Image exists
                      this.set('posts.' + i + '.featuredImage', featuredImage);
                    }.bind(featuredImage, i), function() { // Image doesn't exist
                      featuredImage = app.rootURL + 'content/images/' + this._title + '.png';
                      this._checkImage(featuredImage, function() { // Image exists
                        this.set('posts.' + i + '.featuredImage', featuredImage);
                      }.bind(featuredImage, i), function() { // Image doesn't exist
                        this.set('posts.' + i + '.featuredImage', false);
                      }.bind(featuredImage, i));
                    }.bind(featuredImage, i, title));
                  }.bind(featuredImage, i));
                }.bind(featuredImage, i));
              } else { // title mode
                featuredImage = app.rootURL + 'content/images/' + this.posts[i].slug + '.jpg';
                this._checkImage(featuredImage, function() { // Image exists
                  this.set('posts.' + i + '.featuredImage', featuredImage);
                }.bind(this, featuredImage, i), function() { // Image doesn't exist
                  featuredImage = app.rootURL + 'content/images/' + this.posts[i].slug + '.png';
                  this._checkImage(featuredImage, function() { // Image exists
                    this.set('posts.' + i + '.featuredImage', featuredImage);
                  }.bind(this, featuredImage, i), function() { // Image doesn't exist
                    featuredImage = app.rootURL + 'content/images/' + this.posts[i].datestamp + '.jpg';
                    this._checkImage(featuredImage, function() { // Image exists
                      this.set('posts.' + i + '.featuredImage', featuredImage);
                    }.bind(this, featuredImage, i), function() { // Image doesn't exist
                      featuredImage = app.rootURL + 'content/images/' + this.posts[i].datestamp + '.png';
                      this._checkImage(featuredImage, function() { // Image exists
                        this.set('posts.' + i + '.featuredImage', featuredImage);
                      }.bind(this, featuredImage, i), function() { // Image doesn't exist
                        this.set('posts.' + i + '.featuredImage', false);
                      }.bind(this, featuredImage, i));
                    }.bind(this, featuredImage, i));
                  }.bind(this, featuredImage, i));
                }.bind(this, featuredImage, i));
              }
            } else {
              if (this._isRelativeUrl(this.posts[i].featuredImage)) { // Relative featured image
                this.set('posts.' + i + '.featuredImage', app.rootURL + 'content/images/' + this.posts[i].featuredImage);
              } // else absolute featured image
              this._checkImage(featuredImage, function() { // Image exists
              }.bind(this, featuredImage, i), function() { // Image doesn't exist
                this.set('posts.' + i + '.featuredImage', false);
              }.bind(this, featuredImage, i));
            }
          } else {
            this.set('posts.' + i + '.featuredImage', false);
          }
        },
        
        _isRelativeUrl: function(url) {
          var regex = new RegExp('^(?:[a-z]+:)?//', 'i');
          if (regex.test(url)) { // absolute url
            return false;
          } else { // relative url
            return true;
          }
        },
        
        _checkImage: function(image, success, error) {
          var img = new Image();
          img.onload = success;
          img.onerror = error;
          img.src = image;
        }
      });
    })();
  </script>

</dom-module>
