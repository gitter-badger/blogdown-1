<dom-module id="renderer-md">
  <template>
    <style>
      .markdown-html img {
        max-width: 100%;
      }
    </style>

    <marked-element markdown="[[sanitizedBody]]">
      <div class="markdown-html"></div>
    </marked-element>

  </template>
  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'renderer-md',

        properties: {
          renderer: {
            type: 'string',
            value: 'md'
          }
        },

        attached: function() {
          this.sanitizeBody(this.body).then((sanitizedBody) => {
            this.set('sanitizedBody', sanitizedBody);
          });
        },

        sanitizeBody: function(body) {
          var promises = _.map(body.match(/]\(\/assets\/[^\)]+\)/g), (match) => {
            var src = match.replace('](/assets', '').replace(')', '');
            return document.createElement('blogdown-img').getSrc(src).then((src) => {
              return {
                relative: match,
                absolute: `](${src})`
              };
            });
          });
          return Promise.all(promises).then((sources) => {
            _.each(sources, (source) => {
              body = body.replace(source.relative, source.absolute);
            });
            return body;
          });
        }
      });
    })();
  </script>
</dom-module>
